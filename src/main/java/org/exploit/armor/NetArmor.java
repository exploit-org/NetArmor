package org.exploit.armor;

import org.exploit.armor.config.CommonSecurityConfig;
import org.exploit.armor.config.SecurityConfig;
import org.exploit.armor.encoder.DefaultHtmlEncoder;
import org.exploit.armor.encoder.HtmlEncoder;
import org.exploit.armor.model.CommonConfig;
import org.exploit.armor.password.ArgonPasswordEncoder;
import org.exploit.armor.password.BCryptPasswordEncoder;
import org.exploit.armor.password.PasswordEncoder;
import org.exploit.armor.password.SCryptPasswordEncoder;
import org.exploit.armor.validator.DefaultValidator;
import org.exploit.armor.validator.Validator;
import org.exploit.memory.allocator.DefaultMemoryAllocator;
import org.exploit.memory.allocator.MemoryAllocator;
import org.owasp.validator.html.Policy;

/**
 * NetArmor
 * <p>
 * NetArmor is the main class of armor framework.
 * <p>
 * This class is used to provide armor framework
 * to the application.
 * <p>
 * In case you want to create own custom Armor instance with custom features
 * @see WebArmor
 */
public class NetArmor implements WebArmor {
    private final Validator validator;
    private final HtmlEncoder htmlEncoder;
    private final MemoryAllocator memoryAllocator;
    private final PasswordEncoder passwordEncoder;

    private NetArmor(SecurityConfig config) {
        this.validator = new DefaultValidator(config);
        this.htmlEncoder = new DefaultHtmlEncoder();
        this.memoryAllocator = new DefaultMemoryAllocator();

        switch (config.encoderType()) {
            case BCRYPT: {
                this.passwordEncoder = new BCryptPasswordEncoder(config.bcryptConfig());
                break;
            }
            case ARGON: {
                this.passwordEncoder = new ArgonPasswordEncoder(config.argonConfig());
                break;
            }
            case SCRYPT: {
                this.passwordEncoder = new SCryptPasswordEncoder(config.scryptConfig());
                break;
            }
            default: throw new IllegalArgumentException("Unsupported password encoder");
        };
    }

    @Override
    public Validator validator() {
        return validator;
    }

    @Override
    public HtmlEncoder htmlEncoder() {
        return htmlEncoder;
    }

    // There may be different policies for different pages.
    @Override
    public HtmlEncoder htmlEncoder(Policy policy) {
        return new DefaultHtmlEncoder(policy);
    }

    @Override
    public PasswordEncoder password() {
        return passwordEncoder;
    }

    @Override
    public MemoryAllocator memory() {
        return memoryAllocator;
    }

    public static NetArmor create() {
        return create(new CommonSecurityConfig(new CommonConfig()));
    }

    public static NetArmor create(SecurityConfig config) {
        return new NetArmor(config);
    }
}
